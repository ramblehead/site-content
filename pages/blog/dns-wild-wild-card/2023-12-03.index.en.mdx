---
title: SSL Certificates with DNS Wild Wild Card
authors:
  - Victor Rybynok
draft: true
datePublished: '2023-12-03'
dateUpdated: '2023-12-03'
description:
  Self-hosted wildcard DNS configuration with multiple servers on a single IP
  with similar port numbers (e.g. multiple https on different subdomains) and SSL
  termination.
categories: [dns, wildcard, multi-tenant, ssl, tsl, dns-01, Letsencrypt, ACME, Lego]
---

These instructions were tested on Raspberry Pi OS (64-bit), but should be
compatible with any Debian-based Linux.

For serving multi-tenant self-hosted applications with a single SSL certificate
it is possible to use a DNS provider that supports the following features:

 * Dynamic DNS
 * Wildcard Subdomain Addresses
 * DNS-01 challenge API [supported by Lego](https://go-acme.github.io/lego/dns/)

Dynamic DNS configuration process has been described in [Dynamic
DNS](/blog/dynamic-dns) post.

Wildcard Subdomain Address and DNS-01 challenge configurations are closely
related subjects. Therefore their configurations are both described in the
current post.

However Google Domains is used here as an example, for the new deployments
Google Domains may not be used as it [will no longer
offer](https://support.google.com/domains/answer/13689670?authuser=0&hl=en-GB)
new domain registrations.

## Installing mock web-servers

Two Next.js web servers are used to emulate multi-tenant deployment&nbsp;– one
hosted via node.js and another built statically:

 * Next.js application for mock web site
 * Next.js static for error page

### Installing yarn berry

It is assumed here that [node.js](https://github.com/nvm-sh/nvm) and [yarn
classic](https://classic.yarnpkg.com/en/docs/install) are already installed on
the host computer. If yarn classic is not installed, run the following command
to install it:

```bash
$ npm install yarn -g
```

[corepack](https://github.com/nodejs/corepack) is required to install
project-local [yarn berry](https://yarnpkg.com/):

```bash
$ corepack enable
```

As of the time of writing, I experienced some problems with yarn versions `4.x`,
therefore in this post version `3.x` is used:

```bash
$ yarn set version 3.x
```

Check yarn berry release [page](https://github.com/yarnpkg/berry/releases) or
use the following command to list available yarn berry versions:

```bash
$ git ls-remote https://github.com/yarnpkg/berry.git --tags @yarnpkg/cli/* | \
      grep -o @yarnpkg/cli/.* | \
      grep -o [^/]*[[:digit:]]$
```

Run the following command to install and setup a latest version of the Next.js
application:

### Installing Next.js application for mock web site

```bash
$ mkdir web-site
$ cd web-site
$ yarn dlx create-next-app@latest .
```

The following are the interactive prompts and possible output of the above
`create-next-app` command:

```
➤ YN0000: └ Completed in 1s 2ms
➤ YN0000: ┌ Fetch step
➤ YN0000: └ Completed
➤ YN0000: ┌ Link step
➤ YN0000: └ Completed
➤ YN0000: Done in 1s 63ms

✔ Would you like to use TypeScript? … No / Yes
✔ Would you like to use ESLint? … No / Yes
✔ Would you like to use Tailwind CSS? … No / Yes
✔ Would you like to use `src/` directory? … No / Yes
✔ Would you like to use App Router? (recommended) … No / Yes
✔ Would you like to customize the default import alias (@/*)? … No / Yes
Creating a new Next.js app in /path/to/web-site.

Using yarn.

Initializing project with template: app-tw


Installing dependencies:
- react
- react-dom
- next

Installing devDependencies:
- typescript
- @types/node
- @types/react
- @types/react-dom
- autoprefixer
- postcss
- tailwindcss
- eslint
- eslint-config-next

➤ YN0000: ┌ Resolution step
➤ YN0032: │ fsevents@npm:2.3.3: Implicit dependencies on node-gyp are discouraged
➤ YN0000: └ Completed in 7s 796ms
➤ YN0000: ┌ Fetch step
➤ YN0013: │ wrap-ansi@npm:8.1.0 can't be found in the cache and will be fetched from the remote registry
➤ YN0013: │ wrappy@npm:1.0.2 can't be found in the cache and will be fetched from the remote registry
➤ YN0013: │ yallist@npm:4.0.0 can't be found in the cache and will be fetched from the remote registry
➤ YN0013: │ yaml@npm:2.3.4 can't be found in the cache and will be fetched from the remote registry
➤ YN0013: │ yocto-queue@npm:0.1.0 can't be found in the cache and will be fetched from the remote registry
➤ YN0000: └ Completed in 0s 585ms
➤ YN0000: ┌ Link step
➤ YN0000: │ ESM support for PnP uses the experimental loader API and is therefore experimental
➤ YN0000: └ Completed in 1s 5ms
➤ YN0000: Done with warnings in 9s 471ms
Initialized a git repository.

Success! Created web-site at /path/to/web-site
```

Lock yarn berry version:

```bash
$ yarn set version 3.x
```

Many node.js packages already work with [Yarn
Plug'n'Play](https://yarnpkg.com/features/pnp), including Next.js. However,
there may still be packages that are conflicting with Yarn Plug'n'Play. To
support such packages add the [following
line](https://yarnpkg.com/configuration/yarnrc#nodeLinker) to the top of
`/path/to/web-site/.yarnrc.yml` file:

```
nodeLinker: node-modules
```

After changing yarn configuration run install command:

```
$ yarn install
```

Add the [following
lines](https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored)
to `/path/to/web-site/.gitignore` file (assuming
[zero-installs](https://yarnpkg.com/features/caching#zero-installs)):

```
.yarn/*
!.yarn/cache
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/sdks
!.yarn/versions
```

The newly created `web-site` can now be build and deployed on localhost:

```
$ cd /path/to/web-site
$ yarn build
$ yarn start
```

### Next.js static for error page

Next.js static installation instruction are the same as Next.js application
outlined above.

Then navigate browser to [http://localhost:3000/](http://localhost:3000/) and it
should display default Next.js root index page. We are going to use this page as
our self-hosted site.

## Configuring Router Port Forwarding

## Installing and Configuring Nginx

## Installing and Configuring Lego

 * Install and configure golang from binary distro
 * Compile and install lego
 * Use lego to obtain wildcard subdomain certificates using DNS-01 challenge

## Installing and Configuring systemd Lego timer

https://www.mslinn.com/blog/2022/06/15/certbot.html<br />
https://www.mslinn.com/blog/2023/03/02/lego.html
